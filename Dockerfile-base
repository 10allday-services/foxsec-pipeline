# Dockerfile used to build the foxsec-pipeline-base image.
#
# The base image contains the required daemons/emulators for running tests
# but does not contain any source code or compiled pipeline classes.
#
# The base image is intended to work in conjunction with bin/m and is used
# for development/testing. The base image also forms the basis for the complete
# image which is self-contained.

FROM maven:3-jdk-8-alpine

ENV FOXSEC_PIPELINE_IMAGE=base PATH="/root/google-cloud-sdk/bin:${PATH}"

RUN apk --no-cache update && \
	apk upgrade && \
	apk add go memcached redis python3 git musl-dev libc6-compat gcompat tzdata && \
	curl -sSL https://sdk.cloud.google.com | CLOUDSDK_CORE_DISABLE_PROMPTS=1 bash && \
	gcloud config set project foxsec-pipeline && \
	CLOUDSDK_CORE_DISABLE_PROMPTS=1 gcloud components install cloud-datastore-emulator \
	pubsub-emulator beta && \
	env GOPATH=/root/go go get go.mozilla.org/iprepd && \
	env GOPATH=/root/go go install go.mozilla.org/iprepd/cmd/iprepd && \
	mkdir -p /etc/iprepd

COPY docker/iprepd.yaml /etc/iprepd/iprepd.yaml
COPY docker-entrypoint.sh /

WORKDIR /root/project
ENTRYPOINT ["/docker-entrypoint.sh"]
